<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Love Logs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Admin Dashboard</h2>
      <button id="logoutBtn" class="btn btn-danger">Logout</button>
    </div>
    <div class="card p-3 mb-4">
      <div class="row g-2">
        <div class="col-md-4">
          <input type="text" id="searchName" class="form-control" placeholder="Search by name" />
        </div>
        <div class="col-md-3">
          <input type="date" id="startDate" class="form-control" />
        </div>
        <div class="col-md-3">
          <input type="date" id="endDate" class="form-control" />
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" onclick="applyFilters()">Filter</button>
        </div>
      </div>
    </div>
    <div id="logList" class="table-responsive"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAGmvrB3XwlTag_iUJv6jbxuAj615ZBkjg",
      authDomain: "lovecalculator-84ad0.firebaseapp.com",
      projectId: "lovecalculator-84ad0",
      storageBucket: "lovecalculator-84ad0.appspot.com",
      messagingSenderId: "67244028596",
      appId: "1:67244028596:web:892c5cba5fd42fecacdde1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const logList = document.getElementById("logList");

    // Require login
    auth.onAuthStateChanged((user) => {
      if (!user) {
        alert("Access denied. Please log in.");
        window.location.href = "login.html";
      } else {
        loadLogs();
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => window.location.href = "login.html");
    });

    let allLogs = [];

    function loadLogs() {
      db.collection("results").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        allLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayLogs(allLogs);
      });
    }

    function displayLogs(logs) {
      if (!logs.length) {
        logList.innerHTML = "<p>No results found.</p>";
        return;
      }

      let html = `<table class="table table-striped">
        <thead><tr><th>Name 1</th><th>Name 2</th><th>Percentage</th><th>Date</th></tr></thead><tbody>`;
      logs.forEach(log => {
        const date = log.timestamp?.toDate().toLocaleString() || 'N/A';
        html += `<tr>
          <td>${log.name1}</td>
          <td>${log.name2}</td>
          <td>${log.percentage}%</td>
          <td>${date}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      logList.innerHTML = html;
    }

    function applyFilters() {
      const nameFilter = document.getElementById("searchName").value.toLowerCase();
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const startDate = start ? new Date(start) : null;
      const endDate = end ? new Date(end + 'T23:59:59') : null;

      const filtered = allLogs.filter(log => {
        const nameMatch = log.name1.toLowerCase().includes(nameFilter) || log.name2.toLowerCase().includes(nameFilter);
        const logDate = log.timestamp?.toDate();
        const dateMatch = (!startDate || logDate >= startDate) && (!endDate || logDate <= endDate);
        return nameMatch && dateMatch;
      });

      displayLogs(filtered);
    }
  </script>
</body>
</html>
